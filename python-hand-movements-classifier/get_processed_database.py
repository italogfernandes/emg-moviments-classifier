#!/usr/bin/env python3
# -*- coding: utf-8 -*-

#%% Importing the libraries
import pandas as pd # reading files
import numpy as np # handling numerical data
import matplotlib.pyplot as plt # Plotting
from scipy import signal

#########################
#%% Importing the dataset
#########################

volunteer_id = 1
dataset = pd.read_csv('datasets/volunteer_'+str(volunteer_id)+'.csv', sep=',',
 nrows=150000)

emg_channels = dataset.iloc[:, 1:-1].values
emg_out = dataset.iloc[:, -1].values

dataset = None

#########################
#%% Pre-processing simulating real time implementation
#########################

Fs = 1000.0 # Sampling Freq

#########################
#%% Designing filters
#########################
Fstop_high = 65.0  # Frequency to remove with band stop filter - 60Hz
Fstop_low = 55.0;
Fpa = 3.0 # Highpass cut-off frequency - Removes the offset generated by a DC signal
Fpb = 10.0 # Lowpass cut-off frequency - Smooths the signal
Npa_0db = np.sqrt(0.1024 + (Fpa/Fs)**2) / (Fpa/Fs)
Npb_0db = np.sqrt(0.1024 + (Fpb/Fs)**2) / (Fpb/Fs)
Nstoplow_0db = np.sqrt(0.1024 + (Fstop_low/Fs)**2) / (Fstop_low/Fs)
Nstop_high_0db = np.sqrt(0.1024 + (Fstop_high/Fs)**2) / (Fstop_high/Fs)
print("qnt points %.2f | %.2f | %.2f -> %.2f " % (Npb_0db, Npa_0db, Nstoplow_0db, Nstop_high_0db))

Nhp = 100
Nlp = 32
N65hz = 5
N55hz = 6
print("high_pass filter for offset: %.2f" % (Fs * 0.32 / np.sqrt((Nhp**2)-1)))
print("low_pass filter for envelope: %.2f" % (Fs * 0.32 / np.sqrt((Nlp**2)-1)))
print("band_stop filter f1: %.2f" % (Fs * 0.32 / np.sqrt((N55hz**2)-1)))
print("band_stop filter f2: %.2f" % (Fs * 0.32 / np.sqrt((N65hz**2)-1)))
print("Total atraso: %.3f s" % ((1/Fs) * (Nhp+Nlp+N55hz+N65hz)))

#########################
#%% Applyting filters
#########################

emg = emg_channels[:,0]

emg_60hz = do_band_stop_mva(emg, N55hz, N65hz)
emg_60hz_offset = do_high_pass_mva(emg_60hz, Nhp)
emg_60hz_offset_envelope = do_moving_average(np.abs(emg_60hz_offset), Nhp)

emg_offset = do_high_pass_mva(emg, Nhp)
emg_offset_60hz = do_band_stop_mva(emg_offset, N55hz, N65hz)
emg_offset_60hz_envelope = do_moving_average(np.abs(emg_offset_60hz), Nhp)

emg_60hz_envelope = do_moving_average(np.abs(emg_60hz), Nhp)

################################
#%% super plot
################################
ax1 = plt.subplot(4,2,1)
plt.plot(emg)
#plt.plot(emg_60hz_offset)
plt.title("EMG")
ax2 = plt.subplot(4,2,3)
plt.plot(emg_60hz)
plt.title("After 54Hz to 65Hz filter")
ax3 = plt.subplot(4,2,5)
plt.plot(emg_60hz_offset)
plt.title("After High pass 3Hz filter")
ax4 = plt.subplot(4,2,7)
plt.plot(emg_60hz_offset_envelope)
plt.title("After Envelop with 10Hz filter")

ax11 = plt.subplot(4,2,2)
plt.plot(emg)
#plt.plot(emg_offset_60hz)
plt.title("EMG")
ax12 = plt.subplot(4,2,4)
plt.plot(emg_offset)
plt.title("After High pass 3Hz filter")
ax13 = plt.subplot(4,2,6)
plt.plot(emg_offset_60hz)
plt.title("After 54Hz to 65Hz filter")
ax14 = plt.subplot(4,2,8)
plt.plot(emg_offset_60hz_envelope)
plt.title("After Envelop with 10Hz filter")

ax1.get_shared_x_axes().join(ax1, ax2, ax3, ax4, ax11, ax12, ax13, ax14)
ax1.get_shared_y_axes().join(ax1, ax2, ax3, ax11, ax12, ax13)
plt.tight_layout()
plt.show()

#########################
#%% Windowing
#########################
#TODO


###############################
#%% Optional: Plotting the data
###############################

# Here we use the matplotlib library to plot a small window of the signal
# And verify if everything is all right

fig = plt.figure()
axes = [None for i in range(4)]
for i in range(4):
    axes[i] = plt.subplot(4,1,i+1)
    plt.plot(emg_channels[:,i])
    plt.plot(emg_out[:]/10.0)
    plt.title('Ch ' + str(i+1))
    plt.ylim((-1,1))
    plt.grid()

axes[0].get_shared_x_axes().join(axes[0],axes[1],axes[2],axes[3])
axes[0].get_shared_y_axes().join(axes[0],axes[1],axes[2],axes[3])
axes[0].set_xticklabels([])
axes[1].set_xticklabels([])
axes[2].set_xticklabels([])
plt.show()
